# 0.修复执行导入操作后（比如正则，预设，脚本等等）聊天记录偶发清空的问题

- 调整 `public/script.js`，为 `getChatResult()` 引入 `lastChatLoadFresh` 标记，并在 `reloadCurrentChat()` 中建立聊天数据快照与恢复流程。当旧有空响应重载时自动回滚、阻止 `saveChatConditional()` 覆盖原有 JSONL。
- 新增 `cloneChatMessages`/`snapshotChatState`/`restoreChatState` 工具，连同 itemized prompts、扩展提示与虚拟化窗口一并恢复，并通过中文警告提醒用户检查聊天文件，避免历史遗留 bug 造成数据丢失。

# 1.对几乎所有的英文进行汉化（包括控制台日志），如：

- “An unknown error…” 翻译为 “计数标记时发生未知错误。进一步的信息可以在控制台中获得（如果你是搭建的反代可尝试公益站）”；
- “Could not get a reply from API…” 翻译为 “无法从API获得答复\n请检查你的API和密钥后重试。”；
- “Chat Completion API” 翻译为 “聊天补全API”；
- 新增 “Unable to connect” → “无法连接”。
- 数百条翻译...

----------------------------------------------------------------------------------------------------------------------------------------------------------



# 2.将一些默认值进行修改，如“禁用外部媒体”的按钮现在默认为关闭而非打开，“在聊天消息中请求{{user}}/{{char}}”默认打开，“自动解析”默认打开等等
**移除了 public/style.css、public/scripts/extensions/gallery/style.css 中对 /img/down-arrow.svg 的背景引用，取消自定义下拉箭头以避免 404 请求。**

----------------------------------------------------------------------------------------------------------------------------------------------------------



# 3.引入硬核虚拟化与增量 diff，驱动聊天与角色面板。虚拟容器通过 DocumentFragment 批处理 DOM，并利用 scheduler.postTask 切片长循环，目标是稳定在 16 ms 帧预算内。

&nbsp;  - 抽象 VirtualList 管理器，维护完整数据数组与可视窗口区间，对外暴露 ensureRendered/forEachVisible 等接口，统一驱动聊天与角色渲染。

&nbsp;  - 首次绘制及批量补帧使用 DocumentFragment + requestIdleCallback（或 scheduler.postTask）分帧插入节点，结合增量 diff 避免长任务阻塞。

&nbsp;  - 聊天面板采用"最后 N 条 + 上方占位"策略，维持虚拟高度并在滚动事件中刷新窗口，兼顾 streamingProcessor 的持续写入需求。

&nbsp;  - 角色列表复用虚拟化容器，在分页/筛选回调中 diff 数据、仅替换变动项，同时保留现有分页 UI。

&nbsp;  - 提供可配置开关与性能探针，记录帧耗与渲染时间，允许按需回退以保障扩展兼容。

&nbsp;  - `addOneMessage` 统一在挂载前后广播 `st-message-before-mount`、`st-message-rendered`，无论虚拟化开启与否，扩展都能获知节点生命周期。

&nbsp;  - 新增 `st-chat-render-start`、`st-chat-render-end` 事件，并对 `virtualization-toggle` 补发 `virtualization-toggle-complete`，便于增量 diff 在批量刷新后重建状态。

&nbsp;  - `registerMessageDom`/`unregisterMessageDom`/`reassignMessageDomId`/`rebuildMessageDomRegistry` 改为导出并挂到 `window`，扩展自定义 DOM 时可主动维护索引。

&nbsp;  - 非虚拟化路径补齐 `notifyMessageMounted`，并复用统一事件流，解决扩展仅在手工插入消息时无法收到 `st-message-mounted` 的问题。

&nbsp;  - 虚拟化切换时合并 `printMessages`/`printCharacters` Promise，保证 DOM 重绘完成后再发布完成事件，避免扩展提前读取旧状态。

&nbsp;  - 样式延迟加载改用优先级队列，代码高亮等关键外链以 `data-style-priority`=0 先行注入，其他资源按默认优先级排队。

&nbsp;  - 渲染阶段现在由 `public/scripts/chat/render-pipeline-config.js` 与 `render-task-queue.js` 协同管理，阶段事件统一通过 `chat-events` 模块广播，扩展可在 after-hydration 阶段接入自定义收尾逻辑而无需改核心。

&nbsp;  - `queuePostHydrationTasks` 内置 DOM diff，重复渲染时跳过 `.html()` 写入并携带 `diffSkipped` 标记仍广播阶段事件，保障增量 diff/扩展监听同步。

&nbsp;  - 多队列调度器持续统计峰值长度、平均耗时并在溢出时自动降级，相关数据通过 `window.__renderTaskDebug__` 的 `snapshot/subscribe` 输出，便于 DevTools 监控。

- 聊天窗口采用 `VirtualList` 保持分页逻辑不变，同时通过 `chatRenderStart` 控制渲染窗口。

- `Show more messages` 按钮仍然作为分页入口，但会被虚拟化主动插入在顶部占位符之前。

- 任何修改消息内容（流式输出、附加多媒体）后，需要调用 `chatVirtualList.notifyItemMutated(mesId)`，核心流程已在 `addOneMessage` 与 `StreamingProcessor` 内自动处理。



----------------------------------------------------------------------------------------------------------------------------------------------------------



# 4.将高开销计算迁移至 Web Worker。宏替换、提示拼装、ZIP 解析等集中在 Worker 执行，结合 SharedArrayBuffer 消息池流式回传，保持极低输入延迟。


&nbsp;  - 为 `public/scripts/tokenizers.js` 中的本地编码、批量计数封装统一缓存与模型拆分策略，减少重复请求并避免大规模同步遍历阻塞。

&nbsp;  - 将 `public/scripts/macros.js`、`PromptManager.js`、`itemized-prompts.js` 的宏展开与提示拼装逻辑整理为纯数据输入输出，交由 Worker 执行分段合成，主线程仅负责 UI 状态与任务调度。

&nbsp;  - 把 `public/scripts/utils.js` 内 PDF/EPUB/ZIP 解包、`data-maid.js` 的报告压缩解析等大文件处理迁移至独立 Worker，结合消息池实现页面加载阶段的流式回传与进度提示。

&nbsp;  - 设计可扩展的 Worker 池与任务协议，支持 SharedArrayBuffer 加速字节拷贝，并在 `power\_user` 配置中提供开关以便扩展或旧环境按需回退。

&nbsp;  - Worker 管理器新增 `st-worker-task` 生命周期事件（start/complete/error/fallback），并在主线程禁用时同样广播，扩展可据此同步 UI 或降级逻辑。

&nbsp;  - `workerManager.registerFallback`/`workerManager.extendTaskConfig` 暴露到 `window`，Third-party 扩展可注入自定义回退或覆盖脚本路径，减少直接改核心代码的需求。

&nbsp;  - 任务派发前统一序列化 payload，并在回退/成功时返回清洗后的结果，防止扩展误接收带循环引用的对象。

&nbsp;  - CSRF 缺失导致的 tokenizer 请求异常现已在 Worker 失败路径中完整记录 header/session 信息，便于扩展诊断；若 Worker 不可用立即走同步回退并给出事件提示。

&nbsp;  - Worker 启用状态变更、Fallback 注册、配置扩展均触发 `st-worker-enabled-changed`、`st-worker-fallback-registered`、`st-worker-config-updated`，方便扩展监听平台能力。

----------------------------------------------------------------------------------------------------------------------------------------------------------


# 5.优化输入/事件链路：监听器委托给最近的静态容器，滚动与尺寸调整统一经 requestAnimationFrame 合并，PointerEvent 统一设置 passive，最大限度降低主线程争用。

## public/script.js
- `jQuery(async function () { … })`
  - 引入 `$chat` 快捷引用，所有消息区事件改为在 `#chat` 上委托。
  - 新增 `handleInlineDrawerToggle` / `handleInlineDrawerMaximize`，并使用 `document.body.addEventListener('click', …)` 统一处理 `.drawer-opener`、`.inline-drawer-toggle`、`.inline-drawer-maximize`，替换原先的多处 `$(document).on` 绑定。
  - 使用 `document.body.addEventListener('pointerdown', …)`（passive）替代 `$('html').on('touchstart mousedown', …)`，维持抽屉自动收拢逻辑。
  - 为 `#form_sheld` 建立事件代理，依据 `.stscript_*` 按钮 class 调度 `pauseScriptExecution()` / `stopScriptExecution()`，并对 `#mes_stop` 添加独立监听，完全移除 `$(document).on('click', …)`。
  - 聊天消息相关交互（如 `.mes_copy`、`.mes_edit*`、`.mes_img*`、`.mes .avatar` 等）改为 `$chat.on` 委托，消息编辑输入监听也迁移至同一容器。
- `initMain`：`#amount_gen`、`#max_context` 滑块改为 `delegateLeftNav('input', …, { namespace: 'coreSliders' })`，限制冒泡范围并消除重复绑定。

## public/scripts/util/panel-delegation.js
- 新增 `delegatePanelEvent` / `delegateLeftNav`，统一左侧抽屉与高级格式化面板事件委托，基于命名空间自动 `off` 旧处理器，避免 document 级监听。

## public/scripts/chats.js
- `initChatUtilities`
  - 引入 `const chatContainer = $('#chat');`，将 `.mes_hide / .mes_unhide / .mes_file_* / .mes_embed / .mes_img* / .mes_video_delete / .mes .mes_text / .assistant_note_*` 等事件改为 `chatContainer.on`。
  - 保留扩展注入按钮 (`#attachFile`、`#manageAttachments`) 使用局部 `doc` 代理，避免破坏扩展兼容。

## public/scripts/group-chats.js
- jQuery 初始化块
  - 新增 `const rightNavPanel = $('#right-nav-panel')`、`const groupChatsBlock = $('#rm_group_chats_block')`，把 `#rm_group_chats_block .autoSetHeight` 输入监听改为容器代理。
  - `.group_select` 与 `.group_member .right_menu_button` 事件迁移至 `rightNavPanel.on(...)`，删除 document 级绑定。

## public/scripts/reasoning.js
- `setReasoningEventHandlers`
  - 改用 `const chatContainer = $('#chat');` 统一委托所有 `.mes_reasoning_*`、`.mes_edit_add_reasoning` 以及 `.reasoning_edit_textarea` 相关事件，去除对 `$(document)` 的依赖。

## public/scripts/bookmarks.js
- `initBookmarks`
  - 抽取 `handleBookmarkFollow` 并将 `.mes_bookmark / .mes_create_bookmark / .mes_create_branch` 迁移到 `chatContainer.on`，`'.select_chat_block'` 保持 document 级绑定以兼容弹窗。

## public/scripts/itemized-prompts.js
- `initItemizedPrompts`
  - 使用 `chatContainer.on('pointerup', '.mes_prompt', …)`，替代 document 级监听。

## public/scripts/extensions/caption/index.js
- `jQuery(async function () { … })`
  - 新增 `const chatContainer = $('#chat');`，将 `.mes_img_caption` 事件改为消息区委托。

## public/scripts/extensions.js
- `initExtensions`
  - 移除全局 `$(document).on('click', '.extensions_info …')` 绑定。
- `showExtensionsDetails`
  - 在弹窗根节点 `html` 上委托 `.extension_block` 相关按钮（禁用/启用/更新/删除/移动/创建分支）。

## public/scripts/extensions/tts/index.js
- `jQuery(async function () { … })`
  - 引入 `const chatContainer = $('#chat');`，将 `.mes_narrate` 改为在聊天容器上触发，避免 document 级别冒泡。

## public/scripts/extensions/translate/index.js
- `jQuery(async () => { … })`
  - 添加 `const chatContainer = $('#chat');`，将 `.mes_translate` 事件迁移到消息容器委托。

## public/scripts/kai-settings.js
- `initKoboldSettings`：循环滑块使用 `delegateLeftNav('input', sliderId, …, { namespace: 'koboldSliders' })`，替代 document 级委托并确保去重。

## public/scripts/nai-settings.js
- `initNovelAISettings`：所有采样滑块迁移至 `delegateLeftNav('input', …, { namespace: 'novelSliders' })`，保持动态 preset 仍可触发。

## public/scripts/textgen-settings.js
- 文本生成滑块与输入框统一调用 `delegateLeftNav` 并设置 `namespace: 'textgenSettings'`，保留对 `x-setting-id` 属性的使用。

## public/scripts/openai.js
- Fallback 自适应高度监听改为 `delegateLeftNav('input', '#openai_settings .autoSetHeight', …, { namespace: 'openaiAutoHeight' })`，仅在左侧抽屉内响应。

## public/scripts/preset-manager.js
- 引入 `delegatePresetEvent`（基于 `delegatePanelEvent`），在 `#left-nav-panel, #AdvancedFormatting` 上委托 `data-preset-manager-*` 系列点击/变更事件，命名空间区分 `update/new/rename/export/import/delete/restore`，清理全部 document 级绑定。


----------------------------------------------------------------------------------------------------------------------------------------------------------


# 6.降低高频滚动与操作时的卡顿


&nbsp;  6.1 DOM 减脂

&nbsp;  - 精简聊天、扩展面板等高频区的节点层级与数量，替换遗留 `<font>` 标签等过度包装，目标是降低 18 层深度与 1.8 万节点规模。

&nbsp;  - `addOneMessage()` 针对超长消息改用 `<template>` + `DocumentFragment` 插入，避免大字符串多次触发 HTML Parser 并减少 innerHTML 重渲染带来的同步阻塞。

----------------------------------------------------

&nbsp;  6.2 样式/布局削峰

&nbsp;  - 高频更新时优先使用 `transform`/`opacity`，必要的尺寸调整按帧批量写入，并通过 rAF/requestIdleCallback 拆分长任务，减少对数千元素的重算。

&nbsp;  - `finalizeChatRender()` 和 VirtualList 通知统一经 requestAnimationFrame 合并，同帧内完成 `.last_mes` 切换、样式刷新与滚动，避免多次强制重排。

----------------------------------------------------

&nbsp;  6.3 批量挂载

&nbsp;  - `printMessages()` 非虚拟化路径使用 `DocumentFragment` 一次性追加全部消息节点，并手动补发 `notifyMessageMounted` 等生命周期事件，显著降低高帧率下的多次 append 开销。

----------------------------------------------------

&nbsp;  6.3 设置开关分组数据化

&nbsp;  - 将 `public/index.html` 内主题、角色处理、杂项、聊天处理等 50 余个复选框收敛为模板 + 配置数组生成，保留既有 ID/i18n/提示与图标。
&nbsp;  - 对应 `power_user.js` 读写逻辑无需改动，脚本在 DOMContentLoaded 后统一克隆模板并挂载事件，便于后续增减开关或扩展注入。
&nbsp;  - DOM 层面减少约 70–80 个重复标签与嵌套节点，设置面板首次加载与切换时的布局/样式计算成本预计降低 5–8%（典型面板 DOM 节点规模约 1.5 万时）。

----------------------------------------------------

&nbsp;  6.4 power-user.js 控件同步与开关模块化

&nbsp;  - `loadPowerUserSettings()` 引入 `applyControlBindings`，利用控件映射表统一处理 checkbox/select/text/attr 的同步、触发与后置逻辑，避免数百行重复的 `$('#id').prop()/val()` 调用。
&nbsp;  - 新增 `toggleModules`/`applyToggle()`，按主题、聊天、性能三类封装 `switch*` 开关，复用类名切换、复选框同步、提示节流与事件广播，保持虚拟化/worker 提示等既有行为不变。
&nbsp;  - 重构减少重复绑定与条件分支，后续新增开关仅需配置数据即可落地，实现维护集中、异常处理统一且不改变业务流程。

----------------------------------------------------

  6.5 消息渲染管线与调度策略收敛

  - DOM 映射分层：`public/scripts/chat/message-dom-map.js` 中将消息 id/avatar/timestamp 等字段整理成 `ROOT_ATTRIBUTE_RULES` + `NODE_RULES`，`addOneMessage()` 与 `getMessageFromTemplate()` 只需一次 `applyMessageDomMapping()` 即可完成属性写入，避免手工 setAttribute/innerHTML 的重复调用。
  - 阶段配置可视化：`public/scripts/chat/render-pipeline-config.js` 记录内建阶段优先级与异步特性，并通过 `describeStages()` 将 `stageMetadata` 注入 `chat-render-stage` 事件；调试或扩展接入时可直接查看当前管线顺序、耗时标识。
  - 生命周期守卫：`public/scripts/chat/message-lifecycle.js` 协调 DOM 事件与 `eventSource`，`safeEmit()` 在广播前会检测是否有监听者，既保留兼容扩展的钩子，又避免无监听时的 Promise 链开销。
  - 虚拟化合帧：新增 `queueVirtualListUpdate()` 将 `scheduleMeasurement` 和 `notifyItemMutated` 合并至 rAF 执行，一帧内的多次媒体 load/error 也只触发一次测量，从根源减少 BeginMainFrame 超时；渲染任务的实际排程委托给多队列调度器（详见第 16 点）。
  - 保存调度集中化：`public/scripts/util/save-scheduler.js` 提供 `defineSaveScheduler()` + `createSaveScheduler()`，`queueGlobalSettingsSave` 与 Kobold/NovelAI/TextGen 等面板统一走 rAF 合并，便于后续新增面板时按配置启用。
  - 渲染任务调度升级为 `public/scripts/chat/render-task-queue.js` 内的多队列管理器：按 `pipeline` / `media` / `extension` 三路拆分，分别设置帧预算与单批上限；当总积压超过 150 条时会优先丢弃允许降级的低优先级任务（支持自定义 `onDrop` 回调），同时持续向 `window.__renderTaskDebug__` 暴露队列快照与指标。

--------------------------------------------------------------------------------------------------------------


# 7.优化内存泄漏

   7.1 内存治理策略

   - 聊天消息 iframe：为 JS-Slash-Runner 扩展补齐销毁流程，关闭或滚动移除时主动调用 iframe 内 `eventClearAll`、回收 blob URL、解绑 ResizeObserver，并以 requestIdleCallback/rAF 分批渲染避免长时间持有巨型 DOM 字符串。
   - 世界书弹窗：监听 `#world_popup` 显隐，关闭即取消未完成的分页批处理、清空 `#world_popup_entries_list`、销毁分页插件，防止长时间保留批量节点。
   - Handlebars 模板：对 Story String 与 Bias 模板新增 LRU 缓存，复用编译结果，降低重复创建匿名函数导致的堆内存增长。
   - `public/script.js`：
   - `convertMarkdownWithCache()` + SHOWDOWN LRU（50 项），在 `reloadMarkdownProcessor()` 时清空缓存。
   - 多队列渲染调度器负责分帧渲染与长任务降级，虚拟化切换事件会显式刷新对应队列，必要时丢弃低优先级任务以保持帧预算。
   - 新增 `registerDynamicStyle()` / `releaseDynamicStylesFromElement()`，`decodeStyleTags()` 仅生成 `mes_style_anchor` 标记，样式统一挂载到 `<head>` 并计数回收。
   - `document.body` 的 `pointerdown` 监听增加 40 ms 节流（`BODY_POINTER_THROTTLE_MS`）。
   - `enableLazyMediaResources()`、`appendMediaToMessage()` 为消息内图像/视频补齐 `loading="lazy"`、`decoding="async"`、 `preload="metadata"`。
   - `deleteLastMessage()`、`clearChat()` 在移除 DOM 前释放样式引用，避免 ShadowRoot/Text 泄漏。
   - `public/scripts/chats.js`：`decodeStyleTags()` 计算 CSS 哈希并调用 `registerDynamicStyle()`，不再在消息内重复插入 `<style>`。
   - 外链样式延迟：`decodeStyleTags()` 记录 `@import` URL，`processStyleImportAnchors()`/`queueExternalImports()` 利用渲染队列异步插入 `<link>`，避免阻塞主线程。

----------------------------------------------------------------------------------------------------------------------------------------------------------

# 8.统一面板事件调度与设置保存削峰

   8.1 已完成优化

   - 在 `public/scripts/util/panel-delegation.js` 新增 `createPanelSaveScheduler`，利用 `requestAnimationFrame` 合并高频 input 事件的设置写入。
  - Kobold / NovelAI / TextGen / OpenAI 面板分别引入 `queue*Save` 调度器（`kai-settings.js:29`、`nai-settings.js:25`、`textgen-settings.js:27`、`openai.js:82`），滑块与文本输入仅更新内存状态，保存由调度器批量触发。
  - 全局设置（角色重命名、世界书挂载等）统一通过 `public/script.js:904` 的 `queueGlobalSettingsSave()` 派发，避免单流程内多次 `saveSettingsDebounced()`。
  - 保留原有 `saveSettingsDebounced` 作为最终持久化入口，兼容扩展与旧流程；若调度器未启用或极低频场景仍可直接调用。

----------------------------------------------------------------------------------------------------------------------------------------------------------

# 9.服务端缓存与请求限额

  9.1 已完成优化

  - `src/middleware/accessLogWriter.js` 的 `knownIPs` 改为带 TTL/LRU 的 `Map`，默认保留 24h，超限（默认 5000）时按最早访问驱逐并输出调试日志。
  - `src/endpoints/tokenizers.js` 将 `tokenizersCache` 改写为 LRU `Map`，默认最大 8 条、保活 60 分钟，淘汰时调用 `.free()` 释放原生资源。
  - 全局 JSON/表单限额下调至 25 MB，并在 `docs/request-body-limits.md` 列出例外路由；`/api/chats`、`/api/backends/chat-completions`、`/api/data-maid` 分别提升到 200/50/150 MB。
  - `multer` 上传配置接入 `uploads.maxFieldSizeMb` 与 `uploads.avatarMaxFileSizeMb`，默认 200 MB 与 10 MB；新增 `tests/manual/request-body-limits.md` 验证脚本。
  - `power_user` 主题色默认在 DOMContentLoaded 后加载，避免首屏 `getComputedStyle` 强制回流；暴露 `hydrateSmartThemeDefaults` 供主题切换复用。
  - 将 `saveSettingsDebounced` 按别名导入为 `saveSettingsDebouncedImmediate`，并新增本地函数 `saveSettingsDebounced()`，内部通过 `queueOpenaiSave()`（rAF 合并）触发保存，确保聊天补全面板的高频输入统一走调度；`queueOpenaiSave()` 继续调用原始保存函数，事件处理器及内部逻辑调用 `saveSettingsDebounced()` 即可享受削峰效果。
  - 针对仍直接调用保存的局部场景，补充 `queueOpenaiSave()`，保持与其他面板一致的写入模式。
  - 新增 `src/cache/TtlLruCache.js`，提供统一的 TTL + LRU 缓存封装，支持淘汰回调与淘汰统计。
  - `src/middleware/accessLogWriter.js` 的 `knownIPs`、`src/endpoints/tokenizers.js` 的 tokenizer 缓存改用统一工具，淘汰时自动释放资源并输出调用日志。
  - `src/endpoints/chats.js`、`src/endpoints/settings.js` 引入带 TTL 的函数缓存，防止长尾用户句柄长期驻留；淘汰时自动执行 `flush()`，避免遗漏备份。
  - `src/endpoints/classify.js` 的文本分类结果、`src/endpoints/data-maid.js` 的清理令牌、`src/users.js` 的目录映射均加入 TTL/LRU 防护，降低长期运行场景下的堆积风险。
  - 新增可调上限：`backups.chat.handleCacheLimit`、`backups.settings.handleCacheLimit`、`users.directoryCacheLimit`、`users.directoryCacheMinutes`，默认值分别为 1000、1000、5000 与 30 分钟，可按运行规模调整。

----------------------------------------------------------------------------------------------------------------------------------------------------------

# 10.请求体限额与流式处理

| 路由范围 | 当前状况 | 拟定改造 | 备注 |
| -------- | -------- | -------- | ---- |
| 全局 `bodyParser.json/urlencoded` | 统一设置为 `500mb`，浪费内存且易被滥用 | 下调默认值至 `25mb`，其余路由按需覆盖 | 与 `multer` 并存，避免 JSON 请求撑爆内存 |
| `/api/chats` | 导入/保存聊天记录走 JSON（批量保存）或 `multer` 文件上传 | `router.use(express.json({ limit: '200mb' }))`，同时在 `import` 上传结束后流式写入、释放缓存 | 覆盖 `save`/`import` 产生的超大 JSON 数组 |
| `/api/content`、`/api/assets` | 局部走 JSON，主要是下载任务拼接 URL | 保持默认 25 MB；下载流程继续使用流式管道 | 无需额外放宽 |
| `/api/backends/chat-completions` | 传递 prompt/config JSON，可能包含大量上下文 | 设定 50 MB 限额，并对 streaming body 引导走 SSE | 兼容现有 worker/代理逻辑 |
| `/api/data-maid` | 上传导出报告（ZIP/Base64） | 调整为 150 MB，并尽量改用流模式写临时文件 | 仍保留错误处理和磁盘回收 |
| `/proxy/:url(*)` | 目前关闭时返回 404；开启后 `http-proxy` 走流式 | 交给 `corsProxyMiddleware` 内部控制；仅在开启时检查 `content-length` 超限 | 不额外设置 JSON 解析 |
| Multer `fieldSize` | 500 MB 固定 | 根据 `uploads.maxFieldSizeMb` 配置，默认 200 MB；保留头像上传 10 MB | 避免表单域撑爆内存 |

----------------------------------------------------------------------------------------------------------------------------------------------------------

# 11.后端可观测与任务基座

- 缓存统一入口  
  `src/utils/cacheFactory.js#createCache` 现负责创建/登记所有 TTL+LRU 缓存，自动统计命中率、淘汰来源与最大容量。Access Log（knownIPs）、tokenizer 实例、用户目录、聊天备份调度、设置 autosave、DataMaid 清理凭据与分类结果等均已迁移至该工厂，后续新增缓存只需调用 `createCache(name, options)` 即可被 `/metrics` 捕获。

- 路由限额与监控开关  
  `src/server-main.js` 按功能域挂载 `createJsonParser`，为 `/api/chats`、`/api/backends/chat-completions`、`/api/data-maid` 与 `/api/extensions` 配置独立 JSON 限额，同时新增 `server.extensionsJsonLimitMb`、`server.exposeMetrics` 配置项。将 `exposeMetrics` 设为 `true` 时，会自动开放 `/metrics`（JSON）与 `/metrics/prometheus`（text/plain）端点。

- Access Log 增强  
  `src/middleware/accessLogWriter.js` 通过 `registerAccessLogAugmenter` 向外暴露日志扩展点，扩展或插件可安全地为新连接附加来源、标签等信息，淘汰时也会打印调试日志。

- 指标输出  
  `src/metrics/index.js` 汇总缓存/队列数据，除 JSON 外新增 Prometheus 文本格式，便于监控系统直接拉取。当前输出包括缓存条目数、命中/未命中次数、淘汰分布，以及各注册队列的积压情况；配置示例、校验步骤见 `docs/backend-metrics-and-queues.md`。

- 后台任务队列  
  `src/queues/index.js` 提供轻量任务队列并在启动时挂载 `queues:extensions`。默认处理器会把任务分发到 `serverEvents` 的 `EVENT_NAMES.EXTENSION_TASK`，扩展可通过事件监听或调用 `queue.setProcessor(async task => { ... })` 完全接管，未来若引入 BullMQ 只需替换内部实现。

- 使用指南  
  - 监控：在 `config.yaml` 中写入 `server.exposeMetrics: true` 后重启，即可通过浏览器或 Prometheus 访问 `/metrics`。  
  - 队列：在扩展路由中获取 `req.app.get('queues:extensions')` 并调用 `enqueue` 推送任务；若无监听器会落入默认日志，建议先注册处理器。  
  - 验证：参考 `docs/backend-metrics-and-queues.md` 按步骤检查缓存命中率变化、队列堆积与 Prometheus 输出。

----------------------------------------------------------------------------------------------------------------------------------------------------------

# 12.前端扩展 API 封装

## 12.1 SDK 概览
- 建立 `SillyTavern.extensions` 命名空间，统一暴露前端 SDK 接口。
- 子模块包含 `events`、`messages`、`virtualization`、`workers`、`chat`、`worldInfo`、`characters`、`presets`、`ui`、`variables`、`prompts`、`backend`、`macros`、`templates`、`manager`、`errors` 等，涵盖事件订阅、消息 DOM、虚拟化阶段、Worker 调度、世界书/角色/预设管理、界面工具、变量服务、扩展管理与统一错误码。

## 12.2 事件与监听
- `extensions.events.on/off/emit`：事件白名单机制，`emit` 需显式传入 `allowList`。
- `extensions.events.types` / `domEvents`：对核心事件、虚拟化/Worker DOM 事件的常量引用。
- 所有监听返回 `ExtensionEventToken`，可调用 `dispose()` 主动释放。

## 12.3 消息与虚拟化
- `extensions.messages.onMount/onUnmount`：获取消息生命周期通知，可携带 `mesId`、`element`、`message` 等信息。
- `extensions.messages.getElement`：获取消息对应 DOM 节点。
- `extensions.virtualization.Phase` / `onPhase`：枚举并订阅虚拟化阶段，例如 `MOUNT`、`AFTER_RENDER`、`TOGGLE_COMPLETE`。

## 12.4 Worker 协作
- `extensions.workers.dispatch`：统一派发 Worker 任务，支持回退策略参数。
- `extensions.workers.onTaskEvent`：监听 `st-worker-task` 生命周期，便于扩展处理进度/错误。
- `extensions.workers.registerFallback`、`extendConfig`：为自定义任务补充回退逻辑或覆盖配置。
- `extensions.workers.FallbackStrategy`：提供 `IMMEDIATE`、`RETRY` 等常量。

## 12.5 聊天数据接口
- `extensions.chat.getSnapshot({ includeVirtual })`：返回消息列表与虚拟化窗口信息。
- `extensions.chat.mutateMessage(mesId, updater)`：以乐观方式更新消息并触发渲染刷新。
- `extensions.chat.sendUserMessage(payload)`：通过内置流程发送用户消息（支持插入位置、头像、别名等参数）。

## 12.6 世界书接口
- `extensions.worldInfo.books`：封装世界书级管理（`list/load/save/create/delete/rename/duplicate/mutate/openEditor/reloadEditor/editorState/refreshList`）。
- `extensions.worldInfo.entries`：针对单条条目提供 `list/get/create/update/remove/duplicate/move/render`。
- `extensions.worldInfo.editor`：提供 `open/reload/state/refresh` 及 `navigation`、`anchorPosition` 常量。
- `extensions.worldInfo.listBooks()`：返回所有世界书名称；`getBook(name)` 获取指定书籍快照。
- `extensions.worldInfo.listEntries(name, { sort })`：罗列条目（默认按插入序倒序）；`getSettings()` / `updateSettings(partial)` 读写世界书配置。
- `extensions.worldInfo.refresh()` 强制刷新世界书；`forceActivate(entries)` 触发 `WORLDINFO_FORCE_ACTIVATE` 事件。
- `extensions.worldInfo.ensureEmbeddedWorld(characterId)` / `importEmbeddedWorldInfo(characterId)`：检测或导入角色附带的世界书。
- 事件常量 `events.UPDATED` / `events.SETTINGS_UPDATED`，可用 `onUpdated(handler)` / `onSettingsUpdated(handler)` 订阅。

## 12.7 角色管理接口
- `extensions.characters.list({ refresh })`：可选刷新后返回 `{ index, character }` 数组；`get(index)`、`getActive()` 获取角色快照。
- `extensions.characters.setActive(index, { switchMenu })`：切换激活角色；`rename`、`duplicate`、`remove` 对应重命名/复制/删除。
- `extensions.characters.on(eventName, handler)` 或 `onAnyChange(handler)` 监听 `CHARACTER_EDITED`、`CHARACTER_DELETED` 等事件。

## 12.8 预设接口
- `extensions.presets.list(apiId)`：列举目标 API 下的预设；`getSelected(apiId)` 返回当前选中项。
- `extensions.presets.select`、`save`、`saveAs`、`rename`、`remove` 覆盖常见管理操作；`getSettings(apiId, name)` 获取配置快照。
- 事件 `PRESET_CHANGED`、`PRESET_DELETED` 可通过 `presets.on` 订阅。

## 12.9 UI 工具
- `extensions.ui.toggleDrawer(selector, expand?)`、`focus`、`scrollIntoView`、`setClass`、`bodyClass`：封装常用 DOM 操作。
- `extensions.ui.showToast(type, message, title?, options?)`、`showLoader`、`hideLoader`：统一界面提示与加载器控制。

## 12.10 扩展管理器（新增）
- `extensions.manager.listInstalled({ includeManifest })` / `snapshot`：返回当前安装的扩展清单。
- `extensions.manager.listDiscovered()`：读取服务器已发现的内置/第三方扩展。
- `extensions.manager.enable/disable/install/remove/move/switchBranch/update/updateAll/checkUpdates`：统一封装启停、安装卸载、迁移、分支切换与更新；`notify` 参数默认遵循服务器 `config.json` 中的 `extensionToastNotifications` 配置。
- `extensions.manager.getBranches/getVersion/refresh/reloadPending/clearReloadFlag`：提供分支、版本查询与刷新控制能力。
- 方法返回 `{ ok, message?, data?, extension?, reloadRequired }`，便于扩展根据结果更新 UI。

## 12.11 统一错误码
- `extensions.errors` 提供标准化常量，通过 `errors.OK`、`errors.TIMEOUT`、`errors.ABORTED`、`errors.FORBIDDEN`、`errors.BAD_PAYLOAD`、`errors.UNSUPPORTED`、`errors.NOT_FOUND`、`errors.UNAVAILABLE` 等键访问（对应字符串值分别为 `'EXT_OK'`、`'EXT_E_TIMEOUT'` 等）。
- `errors.HANDLER_REJECTED` 额外标识扩展处理器主动拒绝或返回 `false` 的情形，便于统一错误分支。
- 详细说明可参阅《前端扩展SDK说明.md》中的错误码章节。

## 12.12 扩展管理器补充说明
- 具体接口已在 12.10 汇总，此处额外提醒：写操作默认遵循 `extensionToastNotifications` 开关，必要时可通过传入 `notify` 覆盖；同时可在操作后检查 `reloadPending()` 并结合扩展调试面板提示用户刷新，避免重复操作。

## 12.13 迁移指引
- 历史全局函数已打印弃用提示（如 `registerMessageDom`、`registerWorkerFallback`），请改用以上接口。详见 `docs优化文档/extension-migration.md`。
- 提供 `SillyTavernLegacy` 名称空间用于过渡访问，控制台会警告提示迁移路径。
- 建议扩展在初始化时保存 `dispose` 句柄，并在卸载阶段统一释放。

## 12.14 子模块速查
- `worldInfo`：提供世界书列表、条目快照、`books/entries/editor/navigation` 等高级操作及 `forceActivate` 激活能力。
- `characters`：支持角色快照、激活切换、重命名、复制、删除及变更事件订阅。
- `presets`：封装 `getPresetManager` 常用操作，可列举、选中、保存、删除与监听预设事件。
- `ui`：包含常用界面帮助函数（抽屉开合、toast、focus/scroll 等），免去重复 DOM 操作。
- `variables`：集中管理 `power_user` 与 `settings`，提供更新接口并广播 `SETTINGS_UPDATED`。
- `backend`：读取开关状态、刷新、启用/禁用单项 API 并控制日志输出。
- `manager`：统一的扩展生命周期管理入口（安装、启停、更新、分支、刷新等）。

## 12.15 扩展调试面板
- Extensions 抽屉新增 “Extension Debug Panel”，集中展示 eventSource/DOM 事件、变量订阅回调、导入任务进度与扩展日志。
- UI 顶部新增 “开启扩展调试面板（仅开发者打开）” 开关，默认关闭，关闭后调试逻辑完全停用，避免无谓的事件监听与控制台钩子。
- 提供 Pause/Auto Scroll/清空等控件，暂停时先缓冲日志，恢复后批量刷入，避免滚动干扰。
- 导入任务表格直接轮询 `/api/import/tasks/:id`，根据 pending/running/completed/failed 显示状态徽标及错误摘要。
- 拦截 `[SillyTavern.extensions]`、`[SillyTavernLegacy]` 控制台输出，便于定位遗留 API 调用与扩展异常。
- 面板右上角增加“浮窗”按钮，可弹出带遮罩的定位窗口，避免在滚动至底部时反复回到扩展抽屉。

# 13. 变量服务
- 变量核心：`variables.service` 对 `message/chat/global` 三大作用域提供统一的 `get/set/remove/transaction/snapshot`，所有输出都自动克隆，避免外部直接引用底层对象；同时暴露 `variables.store.{message|chat|global}` 便捷封装，传入键名与可选参数即可完成读写。
- 调试与事件：`window.__variableDebug__` 继续暴露 `snapshot/subscribe/get/set/remove`，日常巡检可直接在 DevTools 调用；`variables.subscribe` 触发的事件现同步桥接到 `variables_updated`、`variables_batch_updated`（eventSource）以及 `st-variables-updated` DOM 事件，扩展与核心逻辑都能收到一致的生命周期通知。
- 写入链路：写操作进入微任务队列批量合并，并在广播时附带 `delta/fragments` 差分信息，既减少全量克隆成本，也让监听方能够基于增量处理；`variables.snapshot({ incremental: true })` 会返回自上次追踪以来的差异（默认仍维护全量快照），并新增 `{ track }` 配置控制是否更新内部基准。
- 作用域拓展：服务新增 `character` 与 `script` 作用域，角色变量落在当前角色数据扩展区，脚本变量统一收敛到 `extension_settings.variables.scripts`，事件 detail 会带上 `characterId` / `scriptId`，便于扩展按作用域区分响应策略。
- 扩展 SDK：`SillyTavern.extensions.variables` 新增 `replaceVariables`、`updateVariablesWith`、`insertOrAssignVariables`、`insertVariables`、`deleteVariable` 等 Promise 封装，同时 `snapshot` 接受 `{ incremental, track }`，第三方脚本无需重写批量替换或差分处理逻辑即可落地复杂变量方案。

## 这次的变量服务扩展本身没有去改动核心的 MVU 流程（SillyTavern 仍然按原来的 Model→View→Update 逻辑运作），但对“变量这一块”的“Model”层做了三点增强，间接帮上了忙：
- 状态收敛：原先 message/chat/global 变量分散在多个对象里，现在都经过 variableService 读写，保证模型层是单一事实来源，避免不同扩展在不同位置修改导致数据漂移。
- 事件桥接：每次变量变动都会统一触发 variables_updated / variables_batch_updated（eventSource）以及 st-variables-updated DOM 事件，外层 MVU 或扩展代码更容易感知“Model 已变化”，触发对应的 View/Update。
- 批量事务与快照：transaction、snapshot 让复杂操作能够一次性提交并发送合并后的事件，减少中间态反复刷新，提高变更的可预期性。
**换句话说，MVU 框架本身没被重构，但变量模块的“Model”更干净、可观测性更好，也使得扩展/自定义逻辑和官方 UI 在更新同步上更稳。**

# 14.渲染链路优化
- 维护样式延迟加载的兜底机制；监控渲染任务调度队列并记录指标。
- `renderPipeline.registerStage`、`chat-render-stage` 事件等扩展钩子保持可用，确保正则模板、虚拟化扩展在新版本中稳定运行。

# 15.后端服务拓展
- 统一使用 `createCache` 管理全局缓存（access log、tokenizer、备份函数等），自动记录命中/淘汰数据。
- 根据路由类型设置合理的 `bodyLimit` 与流式处理策略，避免大文件阻塞事件循环。
- 暴露 `/metrics`（JSON/Prometheus 双格式）输出缓存与队列指标，为简单监控或脚本自检提供基础。
- 维持内存任务队列 + 事件广播，作为扩展后台任务的通用入口；在没有 Redis 等外部依赖的前提下，满足现阶段的异步需求。

# 16.消息生命周期广播模块化
- 新建 `public/scripts/chat/chat-events.js`，集中处理虚拟化相关常量、`broadcastChatRender`、`notifyMessageMounted/notifyMessageUnmounted` 以及合帧调度逻辑；内部以状态缓存（待广播消息、原因、虚拟化标记）替代散落在主脚本的全局变量，实现职责隔离。
- 提供 `configureChatEvents()` 注入入口，`public/script.js:735` 注入 `chat` 数据读取、DOM 注册/释放、虚拟化开关判定等依赖，保持既有数据流与性能策略不变；该方式方便后续复用于子页面或测试环境。
- 所有生命周期广播统一走 `dispatchMessageLifecycle()` 与 DOM CustomEvent：扩展依旧能接收到 `st-message-before-mount`、`st-message-mounted`、`st-message-rendered`、`st-message-unmounted` 以及 `st-chat-render-start/end`，并在无监听者时自动短路 Promise 链，避免多余开销。
- 主脚本 `public/script.js` 删除重复的调度/广播函数，仅保留对新模块的调用，结合 `chat-events` 内的 `resolveMessage()` 守卫，确保异常消息不会中断事件链路；`emitVirtualizationDomEvent`、`handleVirtualMessageMount/Unmount` 等桥接逻辑仍然兼容现有扩展和虚拟化回调。
- 新增 `config.json` → `debugLogging` 节点与 `/api/meta/api-toggles` 返回项，按 worldInfo / events / metadata / tokenCache 四路开关前端调试输出；前端统一包裹 `console.debug/log/info/table`，仅在开关启用或 `localStorage.eventTracing=true` 时记录大量日志，默认静默以减轻终端噪声。
- Worker 管理器在重试/回退场景仅提示一次且使用 `console.warn`；`tokenizer-count` 等低风险任务默认抑制重复提示，同时保留 Toastr 黄色提醒，避免未接入 API 时的刷屏。

# 17.聊天离屏卸载（IntersectionObserver）
- 新增 `public/scripts/chat/offscreen-manager.js`，抽象 `OffscreenVisibilityManager` 统一管理 IntersectionObserver 生命周期、元数据缓存与回调分发，避免散落的观察器实例。
- 主脚本监听 `st-message-mounted/unmounted` 与 `st-chat-render-*` 事件：当虚拟化关闭且 `power_user.offscreen_optimization !== false` 时，为每条 `.mes` 消息创建占位符节点，离屏后以 `display:none` 隐藏原消息并用等高占位撑开滚动高度。
- 离屏恢复时复位占位符高度、移除隐藏样式并重插原消息节点，确保编辑、扩展回调和 DOM 查询仍然指向同一个元素。
- 通过 `refreshChatOffscreenState()` 融合虚拟化开关、设置加载/更新、分页加载（`MORE_MESSAGES_LOADED`）与历史重渲染；虚拟化启用或功能关闭时触发 `disableChatOffscreen()`，清理占位符并恢复原样。
- 样式层新增 `.st-chat-offscreen-placeholder` 与 `.st-chat-offscreen-hidden`，让占位元素不可交互、默认透明；不影响既有主题与扩展样式。
- 默认开启（`power_user.offscreen_optimization: true`），如需退回旧行为，可在设置 JSON 将该项置为 `false` 并刷新页面，无需修改扩展或模板逻辑即恢复原有渲染路径。

# 18.预设 / 世界书面板节流优化
- `public/scripts/preset-manager.js` 引入 `defineSaveScheduler('preset-manager-select')`，通过 `queuePresetSelectChange()` 合并同帧内的 `select` 变更；`selectPreset()`、`updateList()` 改用原生 `Option` 与延迟触发 `change`，降低批量导入/重命名时的重复渲染。
- `updateList()` 不再依赖逐项 jQuery `append + trigger`，改为直接维护内部数组并一次性更新 `<select>` 值，减少 reflow 次数。
- `public/scripts/world-info.js` 新增 `queueWorldInfoSettingsSave()`，将原本每次 `input/change` 都立即 `emit` 的流程合并到 `requestAnimationFrame`，同时为搜索框显式应用 `debounce_timeout.quick`，避免快速输入导致的重复过滤与重渲染。

# 19.监听并实时刷新角色与用户人设
- `public/script.js:2619-2634 增加` `updateCharacterCardDescription()`，用于同步角色列表中 `.ch_description` 的实时显示。
- `public/script.js:14217-14249` 调整角色编辑表单监听逻辑：#description_textarea、`#creator_notes_textarea` 在编辑模式下会写回` characters[this_chid]`，刷新 `#creator_notes_spoiler`，并调用上述新函数立即更新角色卡描述，无需刷新页面。
- 在 `public/scripts/personas.js:1113` 新增 `updatePersonaPreviewDescription`，改用 `data-avatar-id` 精确定位卡片，并统一补足三行高度与占位文案，保证实时预览不再依赖旧的 imgfile 属性。
- 调整 `public/scripts/personas.js:1137` 的输入处理逻辑，改为调用新工具函数即时刷新左侧描述，同时保持原有存储与记忆词数计算流程。
- 于 `public/scripts/personas.js:555` 在切换人物调用 `setPersonaDescription()` 时同步刷新预览，避免重新选择后出现旧文本。
- 在 `public/scripts/personas.js:2009` 为“用户设定描述”文本框改成 `focus/blur` 管理的事件绑定：获得焦点时挂载 `input.personaLiveUpdate` 实时监听，失焦时移除监听。

# 20.将部分前端任务改为后端异步执行

## 后端 API 开关管理
- 新增 `config.json` 与 `src/config-json.js`，支持配置 `apiToggles` 与 `apiToggleLogging`。默认启用文本补全、聊天补全、NovelAI、AI Horde、Kobold 五类接口，日志开关默认关闭。
- 新增 `extensionToastNotifications` 开关（配套 `_commentExtensionToastNotifications` 注释），可全局关闭扩展安装/更新等自动 toast 提示，默认启用。
- `server-startup.js` 按开关挂载或跳过对应路由，`server-main.js` 暴露 `/api/meta/api-toggles` 供前端读取当前状态与日志设置。
- 前端 `script.js` 在初始化阶段加载开关信息，拦截被禁用接口并返回 403 JSON；日志输出仅在 `apiToggleLogging = true` 时启用。`kai-settings.js` 对已禁用的 Kobold 接口跳过状态轮询，避免产生多余错误。

## 世界书导入后端化
- `src/utils/world-info-importer.js` 支持 PNG 嵌入数据解析与 Novel/Agnai/Risu 等格式转换，统一输出 SillyTavern 标准 `entries` 结构。
- `src/endpoints/worldinfo.js` 直接解析上传文件（`.png`、`.json`），保存前完成格式转换并返回成功信息。
- 前端 `public/scripts/world-info.js` 改为上传原始文件并等待后端结果；失败时由后端返回 400，提示“无法导入世界书，格式不正确”。

## 角色删除稳定性
- `/api/characters/delete` 在角色文件缺失时记录警告并视为已删除；删除聊天目录失败时仅写日志不中断流程，避免前端残留占位或重复报错。

## 导入解析统一化
### 队列与任务 API
- 新增 `src/services/import-task-manager.js` 与 `src/services/import-processor.js`，负责入队、状态更新、失败处理。
- 新增 `src/endpoints/import.js` 提供 `POST /api/import/parse`、`GET /api/import/tasks/:id`，支持 `character`、`chat`、`preset`、`formatting`、`theme` 类型。每次上传返回任务 ID，前端可轮询状态。
- `server-main.js` 注册 `import:parse` 队列并在退出时释放资源；`server-startup.js` 将新路由挂载至 `/api/import`。

### 角色卡解析
- `src/utils/character-importer.js` 支持 YAML/JSON/PNG/CharX/BYAF 等格式，统一生成 Spec V2 数据、头像 Base64、建议内部文件名及告警信息。
- `src/endpoints/characters.js` 导出 `convertToV2`、`readFromV2`、`unsetPrivateFields` 等工具供解析器复用。

### 聊天记录解析
- `src/utils/chat-importer.js` 集成原有 Kobold Lite、CAI、Oobabooga、Agnai、Risu、Chub Chat 等格式解析，输出标准化 `messages[]` 与元数据。
- 队列任务 `type=chat` 直接调用解析器，`/api/import/parse` 支持聊天文件。

### 预设与高级格式化
- `src/utils/preset-importer.js` 识别单独模板（Instruct、Context、System Prompt、Text Completion、Reasoning）及 master 导出结构，生成规范化数据。
- 队列任务 `type=preset`、`type=formatting` 调用该解析器，前端可获取解析结果再决定落盘。

### UI 主题
- `src/utils/theme-importer.js` 校验主题 JSON，返回主题内容与元数据；队列任务 `type=theme` 走相同流程。

## 现状说明
- 角色/聊天导入已迁移至后端解析；预设、模板、主题亦支持后端解析与任务队列。前端目前仍需在解析完成后调用既有保存接口写入磁盘。
- 世界书导入错误提示已统一为中文；角色删除流程增强了容错。


# 21.优化首次开屏加载时间
- 在 public/service-worker.js 新增静态缓存逻辑（缓存名 st-static-v1），一次性预缓存核心 CSS、Font Awesome 以及 Noto 字体和应用图标，实现首屏离线可用。
- 新建 public/scripts/pwa/register-service-worker.js 并在 public/script.js 引入调用，保证页面加载完成后自动注册上述 Service Worker。
- 调整 public/index.html 移除 style.css 的 preload 链接，避免重复请求。
- 为 Font Awesome 的 @font-face 声明改用 font-display: swap（public/css/solid.min.css、public/css/brands.min.css），与本地 Noto 字体策略保持一致，改善首屏文本可见性。
- 移除了无用的ExtrasAPI。
- 扩展样式优先级队列：`public/script.js:1725-1773` 新增锚点元标签，统一 `registerDynamicStyle` 与外链样式的注入位置，动态 `<style>` 交由头部集中管理并维持引用计数。
- 外链样式加载改为“预加载→样式”流程：`public/script.js:2332-2468` 根据资源类型生成 `rel=\"preload\"` 链接并在加载完成后降级为 `rel=\"stylesheet\"`，字体资源带上 `crossOrigin=\"anonymous\"`，避免阻塞主线程。
- 首屏字体与 FontAwesome 以预加载 + noscript 兜底方式接管（`public/index.html:21-28`），确保旧环境可回退且初始渲染不等待字体。

# 22.事件与网络治理
- 引入统一事件治理工具：`public/script.js:340-441` 新增 `addManagedEventListener`、`scheduleLowPriorityTask` 及默认 passive 事件清单，核心交互改走封装以统一 passive 标记与非关键任务调度。
- 调整主体事件监听：聊天滚动、全局 pointerdown/click 及按钮事件切换至托管封装，拖拽与面板复位异步执行（`public/script.js:14992-14995、16166-16227`），扩展输入缓存延迟到后台空闲执行（`public/scripts/RossAscends-mods.js:1022-1080`）。
- 修复 fetch 包装兼容性：通过 `cloneRequest` 复制完整请求属性，保留扩展认证/跨域信息并追加 CSRF 头（`public/script.js:2844-2909、3128-3186`），解决第三方扩展更新时的跨域获取失败。

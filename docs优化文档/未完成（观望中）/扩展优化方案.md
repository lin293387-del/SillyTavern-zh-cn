# 扩展优化方案（内部规划）

## 目标概览
- 提升扩展开发体验（模板、脚手架、调试工具）
- 提高扩展运行期的可靠性与可观测性
- 扩展本身的能力边界（更多事件、后端任务支持、发现机制）

## 1. 开发者体验
1. 脚手架与示例仓库
   - 建一个官方模板仓库，提供 manifest、入口文件、常用 API 调用示例；带说明文档。
   - 视情况做个 npm 脚手架：`npm init sillytavern-extension`，直接生成项目骨架。

2. Extension DevTools 面板
   - 新增扩展调试 UI：实时显示事件广播、变量更新、导入任务状态。
   - 支持查看扩展日志、抓取 `SillyTavernLegacy` 调用，便于排错。

3. 日志与错误收集
   - 统一日志 API（例如 `SillyTavern.extensions.log`），按扩展 id 归类。
   - 控制台侧也要显示扩展名称，必要时同步写入后端。

4. 文档补齐
   - 在现有 SDK 文档基础上添加常见场景示例：读取变量、提交导入任务、监听任务完成、写入世界书等。
   - 整理 FAQ/排错指南，集中列出常见错误码和处理方式。

## 2. 运行期可靠性
1. 扩展异常隔离
   - 把扩展事件、渲染钩子都包一层 try-catch，不因单个扩展错误影响主流程。
   - 给扩展 DevTools 写入错误详情，标记失败次数。

2. 导入任务超时/重试
   - 给 import 队列的任务默认超时，支持自动重试或返回可重试的错误；扩展 API 里暴露 `onTaskTimeout` 等事件。

3. 权限与能力声明（Manifest 扩展）
   - 扩展 manifest 中声明需要访问的 API（变量、导入能力、队列等），加载时做校验。后续准备接入授权控制。

## 3. 能力扩展与协同（原项目已有扩展页面的ui）
1. 扩展发现与管理（不需要这一步）
   - 先做基础的“扩展管理”页面：列出本地扩展、维护者、简介、启用/停用。
   - 酒馆助手、提示词模板等可在这里挂官方入口。

2. 事件增强
   - 扩充 `event_types`，增加导入任务完成、变量写入成功、API toggle 变化等常用节点。
   - 更新 SDK 让扩展直接监听这些事件。

3. 后端扩展任务接口
   - 在现有 import 队列基础上，开放通用“扩展任务” REST API（提交耗时任务、轮询状态、取消），给扩展一个正规渠道跑后台计算。

4. 配置同步
   - 预研扩展配置/状态同步机制（本地存档 vs. 后端存储），方便多终端共享扩展设置。

## 4. 短期优先级建议
1. DevTools 面板 + 日志隔离：开发调试收益最高。
2. 模板/脚手架：让新扩展快速起步。
3. 事件扩展 + 文档补齐：提升现有扩展能力。
4. 导入任务超时/重试 + 状态事件：改善现有导入链路。
5. 扩展发现/管理（基础版）：增强生态曝光。
6. 权限/后端任务接口：作为中期目标，为后续扩展能力铺路。

## 后续行动（按优先级执行）
- [ ] 原型设计：扩展 DevTools 面板（功能列表、预期 UI、数据接口）
- [ ] 制定日志规范：日志级别、结构、输出渠道
- [ ] 脚手架模板准备：整理示例扩展，补充 README
- [ ] SDK 文档更新：添加常见场景与 FAQ
- [ ] Import 队列增强：超时/重试机制、状态事件
- [ ] 扩展管理页面需求初稿：功能列表、授权机制草案

